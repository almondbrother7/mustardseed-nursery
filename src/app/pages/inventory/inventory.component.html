<ng-container *ngIf="categories.length; else noData">
  <mat-tab-group [(selectedIndex)]="selectedIndex" (selectedIndexChange)="onTabChange($event)">
    <mat-tab *ngFor="let category of categories">
      <ng-template mat-tab-label>
        <span *ngIf="category.icon">{{ category.icon }}</span> {{ category.label }}
      </ng-template>

      <!-- Category Section -->
      <div class="category-info" *ngIf="category">
        
        <!-- Tagline + description -->
        <div class="category-intro category-block" *ngIf="category.tagline">
          <h2>{{ category?.tagline }}</h2>
          <p *ngIf="category?.description">{{ category.description }}</p>
        </div>

        <!-- About -->
        <div class="category-about category-block" *ngIf="category?.about as about">
          <div class="prose" [innerHTML]="about | markdownOrBreaks"></div>
        </div>

        <!-- Helpful links -->
        <div class="category-links category-block" *ngIf="category?.links?.length">
          <h3>Helpful links</h3>
          <ul>
            <li *ngFor="let link of category.links">
              <a [href]="link.url" target="_blank" rel="noopener">{{ link.label }}</a>
            </li>
          </ul>
        </div>

      </div>

      <!-- slim toolbar under intro -->
      <div class="inv-toolbar">
        <div class="inv-toolbar-right">
          <mat-form-field appearance="fill" class="sort-dropdown">
            <mat-label>Sort by</mat-label>
            <mat-select [(ngModel)]="sortOrder" (ngModelChange)="applyFilterSort()">
              <mat-option value="name">Name</mat-option>
              <mat-option value="price">Price</mat-option>
            </mat-select>
          </mat-form-field>

          <div class="inv-toggle-wrap">
            <mat-button-toggle-group
              [(ngModel)]="sortDir"
              (ngModelChange)="applyFilterSort()"
              aria-label="Sort direction">
              <mat-button-toggle value="asc">Asc</mat-button-toggle>
              <mat-button-toggle value="desc">Desc</mat-button-toggle>
            </mat-button-toggle-group>
          </div>

          <mat-checkbox [(ngModel)]="showOutOfStock" (change)="applyFilterSort()">
            Show out of stock
          </mat-checkbox>
        </div>
      </div>


      <!-- Plant Grid -->
      <div class="plant-grid">
        <ng-container *ngIf="plantsFilteredByCategory?.length">
          <div 
            class="plant-card" 
            *ngFor="let plant of plantsFilteredByCategory"
            (click)="openLightbox(plant)"
          >
            <img 
              [src]="normalizeAssetPath(plant.thumbnail) || defaultThumb"
              (error)="onImgError($event)"
              [alt]="plant.name"
             />
            <div class="plant-info">
              <h3>{{ plant.name }}</h3>
              <p class="price">${{ plant.price }}</p>
            </div>
            <button 
              mat-stroked-button 
              color="primary" 
              class="request-button"
              *ngIf="plant.inventory >= 1"
              (click)="reservePlant(plant); $event.stopPropagation();">
              Reserve
            </button>
            <button
              mat-stroked-button
              color="primary"
              *ngIf="plant.inventory < 1"
              (click)="expressInterest(plant)">
              Express interest
            </button>
          </div>
      </ng-container>
    </div>

      <!-- Empty State -->
      <div class="no-inventory" *ngIf="plantsFilteredByCategory.length === 0">
        <p>No plants available in this category right now. Please check back soon!</p>
      </div>
    </mat-tab>
  </mat-tab-group>
</ng-container>

<ng-template #noData>
  <p class="no-data-message">No plants found! Please check back later.</p>
</ng-template>

<app-lightbox [categoryChange]="onCategoryChange.bind(this)"></app-lightbox>
